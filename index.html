<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanism Intercorrelation Network</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFFFF 100%);
            color: black;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95em;
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="file"] {
            flex: 1;
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
        }

        input[type="file"]:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
        }

        select:focus, input[type="range"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.85em;
            color: #6c757d;
        }

        .slider-value span:last-child {
            font-weight: 600;
            color: #667eea;
        }

        .save-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #000000 0%, #000000 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #visualization {
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 800px;
        }

        .legend {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .legend-section h3 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #495057;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #dee2e6;
        }

        .legend-line {
            width: 30px;
            height: 3px;
            margin-right: 10px;
            border-radius: 2px;
        }

        .status {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .tooltip strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mechanism Intercorrelation Network</h1>
            <p>Interactive visualization of partial correlations between psychological mechanisms</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Upload the CSV</label>
                <div class="file-upload">
                    <input type="file" id="fileInput" accept=".csv">
                    <button class="save-btn" id="saveBtn" disabled>Save as SVG</button>
                </div>
            </div>

            <div class="filter-controls">
                <div class="control-group">
                    <label>Integrity Group</label>
                    <select id="groupFilter">
                        <option value="all">All Groups</option>
                        <option value="non_cheaters">Non-Cheaters</option>
                        <option value="partial_cheaters">Partial-Cheaters</option>
                        <option value="full_cheaters">Full-Cheaters</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Partial Correlation Strength (|r|)</label>
                    <div class="slider-container">
                        <input type="range" id="correlationSlider" min="0" max="0.8" step="0.05" value="0.2">
                        <div class="slider-value">
                            <span>0.0</span>
                            <span id="sliderValue">0.20</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="visualization">
            <!--<div class="status">Please upload high_impact_mechanism_intercorrelations.csv to begin</div>-->
        </div>

        <div class="legend">
            <div class="legend-section">
                <h3>Theory Colors</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1f77b4;"></div>
                    <span>Self-Determination Theory (SDT)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff7f0e;"></div>
                    <span>Cognitive Dissonance Theory (CDT)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9467bd;"></div>
                    <span>Self-Efficacy Theory (SET)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #17becf;"></div>
                    <span>Social Norms Theory (SNT)</span>
                </div>
            </div>

            <div class="legend-section">
                <h3>Edge Colors</h3>
                <div class="legend-item">
                    <div class="legend-line" style="background: #2ecc71;"></div>
                    <span>Positive Correlation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: #e74c3c;"></div>
                    <span>Negative Correlation</span>
                </div>
            </div>

            <div class="legend-section">
                <h3>Node Markers</h3>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; border: 3px solid #667eea; border-radius: 50%; margin-right: 10px;"></div>
                    <span>High-Impact Mechanism (R² > 10%)</span>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const mechanisms = [
            'autonomy_need_satisfaction',
            'autonomy_need_frustration',
            'competence_need_satisfaction',
            'competence_need_frustration',
            'relatedness_need_satisfaction',
            'relatedness_need_frustration',
            'cognitive_discomfort',
            'moral_disengagement',
            'perceived_performance_accomplishments',
            'perceived_vicarious_experience',
            'perceived_verbal_persuasion',
            'perceived_emotional_arousal',
            'perceived_descriptive_norms',
            'perceived_injunctive_norms',
            'perceived_group_identification',
            'perceived_social_sanctions'
        ];

        const theoryColors = {
            'autonomy_need_satisfaction': '#1f77b4',
            'autonomy_need_frustration': '#1f77b4',
            'competence_need_satisfaction': '#1f77b4',
            'competence_need_frustration': '#1f77b4',
            'relatedness_need_satisfaction': '#1f77b4',
            'relatedness_need_frustration': '#1f77b4',
            'cognitive_discomfort': '#ff7f0e',
            'moral_disengagement': '#ff7f0e',
            'perceived_performance_accomplishments': '#9467bd',
            'perceived_vicarious_experience': '#9467bd',
            'perceived_verbal_persuasion': '#9467bd',
            'perceived_emotional_arousal': '#9467bd',
            'perceived_descriptive_norms': '#17becf',
            'perceived_injunctive_norms': '#17becf',
            'perceived_group_identification': '#17becf',
            'perceived_social_sanctions': '#17becf'
        };

        const mechanismLabels = {
            'autonomy_need_satisfaction': ['Autonomy', 'Need', 'Satisfaction'],
            'autonomy_need_frustration': ['Autonomy', 'Need', 'Frustration'],
            'competence_need_satisfaction': ['Competence', 'Need', 'Satisfaction'],
            'competence_need_frustration': ['Competence', 'Need', 'Frustration'],
            'relatedness_need_satisfaction': ['Relatedness', 'Need', 'Satisfaction'],
            'relatedness_need_frustration': ['Relatedness', 'Need', 'Frustration'],
            'cognitive_discomfort': ['Cognitive', 'Discomfort'],
            'moral_disengagement': ['Moral', 'Disengagement'],
            'perceived_performance_accomplishments': ['Perceived','Performance', 'Accomplishments'],
            'perceived_vicarious_experience': ['Perceived','Vicarious', 'Experience'],
            'perceived_verbal_persuasion': ['Perceived','Verbal', 'Persuasion'],
            'perceived_emotional_arousal': ['Perceived','Emotional', 'Arousal'],
            'perceived_descriptive_norms': ['Perceived','Descriptive', 'Norms'],
            'perceived_injunctive_norms': ['Perceived','Injunctive', 'Norms'],
            'perceived_group_identification': ['Perceived','Group', 'Identification'],
            'perceived_social_sanctions': ['Perceived','Social', 'Sanctions']
        };

        const mechanismLabelsFlat = {
            'autonomy_need_satisfaction': 'Autonomy\nNeed\nSatisfaction',
            'autonomy_need_frustration': 'Autonomy\nNeed\nFrustration',
            'competence_need_satisfaction': 'Competence\nNeed\nSatisfaction',
            'competence_need_frustration': 'Competence\nNeed\nFrustration',
            'relatedness_need_satisfaction': 'Relatedness\nNeed\nSatisfaction',
            'relatedness_need_frustration': 'Relatedness\nNeed\nFrustration',
            'cognitive_discomfort': 'Cognitive\nDiscomfort',
            'moral_disengagement': 'Moral\nDisengagement',
            'perceived_performance_accomplishments': 'Perceived\nPerformance\nAccomplishments',
            'perceived_vicarious_experience': 'Perceived\nVicarious\nExperience',
            'perceived_verbal_persuasion': 'Perceived\nVerbal\nPersuasion',
            'perceived_emotional_arousal': 'Perceived\nEmotional\nArousal',
            'perceived_descriptive_norms': 'Perceived\nDescriptive\nNorms',
            'perceived_injunctive_norms': 'Perceived\nInjunctive\nNorms',
            'perceived_group_identification': 'Perceived\nGroup\nIdentification',
            'perceived_social_sanctions': 'Perceived\nSocial\nSanctions'
        };

        let data = null;
        let svg = null;

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('groupFilter').addEventListener('change', updateVisualization);
        document.getElementById('correlationSlider').addEventListener('input', handleSliderChange);
        document.getElementById('saveBtn').addEventListener('click', saveSVG);

        function handleSliderChange(e) {
            document.getElementById('sliderValue').textContent = parseFloat(e.target.value).toFixed(2);
            updateVisualization();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    data = results.data;
                    document.getElementById('saveBtn').disabled = false;
                    updateVisualization();
                }
            });
        }

        function updateVisualization() {
            if (!data) return;

            const group = document.getElementById('groupFilter').value;
            const minCorr = parseFloat(document.getElementById('correlationSlider').value);

            // Filter data
            let filteredData = data.filter(d => {
                const absCorr = Math.abs(d.partial_correlation);
                const groupMatch = group === 'all' || d.group === group;
                return groupMatch && absCorr >= minCorr;
            });

            renderNetwork(filteredData);
        }

        function renderNetwork(filteredData) {
            const container = document.getElementById('visualization');
            container.innerHTML = '';

            const width = 1200;
            const height = 1000;
            const radius = Math.min(width, height) * 0.25;
            const centerX = width / 2;
            const centerY = height / 2;

            // Create SVG
            svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            svg.style.maxWidth = '100%';
            svg.style.height = 'auto';

            // Calculate positions
            const angleStep = (2 * Math.PI) / mechanisms.length;
            const positions = {};
            mechanisms.forEach((mech, i) => {
                const angle = i * angleStep - Math.PI / 2;
                positions[mech] = {
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });

            // Get high impact mechanisms
            const highImpactMechs = new Set(filteredData.map(d => d.high_impact_mechanism));

            // Draw edges
            const edgeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            filteredData.forEach(d => {
                const source = d.high_impact_mechanism;
                const target = d.correlated_mechanism;
                
                if (positions[source] && positions[target]) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', positions[source].x);
                    line.setAttribute('y1', positions[source].y);
                    line.setAttribute('x2', positions[target].x);
                    line.setAttribute('y2', positions[target].y);
                    
                    const absCorr = Math.abs(d.partial_correlation);
                    const strokeWidth = 1 + absCorr * 8;
                    const color = d.partial_correlation > 0 ? '#2ecc71' : '#e74c3c';
                    const opacity = 0.3 + absCorr * 0.5;
                    
                    line.setAttribute('stroke', color);
                    line.setAttribute('stroke-width', strokeWidth);
                    line.setAttribute('opacity', opacity);
                    line.style.cursor = 'pointer';
                    
                    line.addEventListener('mouseenter', (e) => showEdgeTooltip(e, d));
                    line.addEventListener('mouseleave', hideTooltip);
                    
                    edgeGroup.appendChild(line);
                }
            });
            svg.appendChild(edgeGroup);

            // Draw nodes
            const nodeGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            mechanisms.forEach(mech => {
                const pos = positions[mech];
                const isHighImpact = highImpactMechs.has(mech);
                
                // Outer circle for high impact
                if (isHighImpact) {
                    const outerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    outerCircle.setAttribute('cx', pos.x);
                    outerCircle.setAttribute('cy', pos.y);
                    outerCircle.setAttribute('r', 18);
                    outerCircle.setAttribute('fill', 'none');
                    outerCircle.setAttribute('stroke', '#667eea');
                    outerCircle.setAttribute('stroke-width', 3);
                    nodeGroup.appendChild(outerCircle);
                }
                
                // Main circle
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', pos.y);
                circle.setAttribute('r', 12);
                circle.setAttribute('fill', theoryColors[mech]);
                circle.setAttribute('stroke', 'white');
                circle.setAttribute('stroke-width', 2);
                circle.style.cursor = 'pointer';
                
                circle.addEventListener('mouseenter', (e) => showNodeTooltip(e, mech, isHighImpact));
                circle.addEventListener('mouseleave', hideTooltip);
                
                nodeGroup.appendChild(circle);
                
                // Label with multi-line text
                const labelLines = mechanismLabels[mech];
                const angle = mechanisms.indexOf(mech) * angleStep - Math.PI / 2;
                const labelRadius = radius + 70;
                const labelX = centerX + labelRadius * Math.cos(angle);
                const labelY = centerY + labelRadius * Math.sin(angle);
                
                // Create text element with tspans for each line
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', labelX);
                text.setAttribute('y', labelY - (labelLines.length - 1) * 7);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '20');
                text.setAttribute('font-weight', isHighImpact ? '700' : '500');
                text.setAttribute('fill', '#2c3e50');
                
                labelLines.forEach((line, i) => {
                    const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspan.setAttribute('x', labelX);
                    tspan.setAttribute('dy', i === 0 ? '0' : '18');
                    tspan.textContent = line;
                    text.appendChild(tspan);
                });
                
                nodeGroup.appendChild(text);
            });
            svg.appendChild(nodeGroup);

            container.appendChild(svg);
        }

        function showNodeTooltip(e, mech, isHighImpact) {
            const tooltip = document.getElementById('tooltip');
            const labelText = mechanismLabelsFlat[mech].replace(/\n/g, ' ');
            tooltip.innerHTML = `
                <strong>${labelText}</strong>
                ${isHighImpact ? '<div style="color: #667eea; margin-top: 5px;">⭐ High-Impact Mechanism</div>' : ''}
            `;
            tooltip.style.display = 'block';
            updateTooltipPosition(e);
        }

        function showEdgeTooltip(e, d) {
            const tooltip = document.getElementById('tooltip');
            const sourceLabel = mechanismLabelsFlat[d.high_impact_mechanism].replace(/\n/g, ' ');
            const targetLabel = mechanismLabelsFlat[d.correlated_mechanism].replace(/\n/g, ' ');
            const direction = d.partial_correlation > 0 ? 'Positive' : 'Negative';
            tooltip.innerHTML = `
                <strong>${sourceLabel} ↔ ${targetLabel}</strong>
                <div style="margin-top: 5px;">Partial r = ${d.partial_correlation.toFixed(3)}</div>
                <div style="color: ${d.partial_correlation > 0 ? '#2ecc71' : '#e74c3c'};">${direction} correlation</div>
                <div style="margin-top: 5px; opacity: 0.8;">Group: ${d.group.replace('_', ' ')}</div>
            `;
            tooltip.style.display = 'block';
            updateTooltipPosition(e);
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function updateTooltipPosition(e) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.left = (e.pageX + 15) + 'px';
            tooltip.style.top = (e.pageY + 15) + 'px';
        }

        function saveSVG() {
            if (!svg) return;

            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svg);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mechanism_network.svg';
            a.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
